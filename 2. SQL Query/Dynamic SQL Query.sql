CREATE PROCEDURE DBO.ORDER_LTV 
	@FACT_TYPE NVARCHAR (400),          /* SALES, QUANTITY ORDERED, REFUND, QUANTITY RETURNED  */
	@DURATION_INDICATOR NVARCHAR (400), /* DAY, MONTH, YEAR */ 
	@DURATION_VALUE INT					/* INTEGER VALUE */
AS
BEGIN
	DECLARE @QUERY NVARCHAR (MAX);
	DECLARE @FIELD_NAME NVARCHAR (200);

	IF @DURATION_VALUE < 1 
	BEGIN
		PRINT 'ERROR: Invalid duration value. You should enter positive integer value.' ;
		RETURN;
	END;  

	-- Confirmation for the parameter @fact_type
	IF UPPER (@FACT_TYPE) NOT IN ('SALES', 'QUANTITY ORDERED', 'REFUND', 'QUANTITY RETURNED')
	BEGIN
		PRINT 'ERROR: Invalid fact type. You should choose one of (SALES, QUANTITY ORDERED, REFUND, QUANTITY RETURNED) ' ;
		RETURN;
	END;

	-- Confirmation for the parameter @duration_indicator
	IF UPPER (@DURATION_INDICATOR) NOT IN ('DAY', 'MONTH', 'YEAR')
	BEGIN
		PRINT 'ERROR: Invalid duration indicator. You should choose one of (DAY, MONTH, YEAR) ' ;
		RETURN;
	END;
	
	IF UPPER (@FACT_TYPE) = 'SALES'
	BEGIN

		SET @QUERY = '
			SELECT 
				ACCOUNT_ID,
				SUM(TOTAL_CHARGED_AMT * QUANTITY_ORDERED) TOTAL_SALES_LAST_' + CAST(@DURATION_VALUE AS NVARCHAR (100))+ '_' + UPPER (@DURATION_INDICATOR) + ' 
			FROM DBO.fact_order
			WHERE QUANTITY_ORDERED > 0
			AND ORDER_DATE_TIME > DATEADD(' + UPPER (@DURATION_INDICATOR) + ',-' + CAST (@DURATION_VALUE AS NVARCHAR (100))+ ',GETDATE())
			GROUP BY ACCOUNT_ID
		';
	END
	ELSE IF UPPER (@FACT_TYPE) = 'QUANTITY ORDERED'
	BEGIN

		SET @QUERY = '
			SELECT 
				ACCOUNT_ID,
				SUM(QUANTITY_ORDERED) TOTAL_QUANTITY_LAST_' + CAST(@DURATION_VALUE AS NVARCHAR (100)) + '_' + UPPER (@DURATION_INDICATOR) + '
			FROM DBO.fact_order
			WHERE QUANTITY_ORDERED > 0
			AND ORDER_DATE_TIME > DATEADD(' + UPPER (@DURATION_INDICATOR) + ',-' + CAST(@DURATION_VALUE AS NVARCHAR (100)) + ',GETDATE())
			GROUP BY ACCOUNT_ID
		';
	END
	ELSE IF UPPER (@FACT_TYPE) = 'REFUND'
	BEGIN

		SET @QUERY = '
			SELECT 
				ACCOUNT_ID,
				SUM(TOTAL_CHARGED_AMT * QUANTITY_RETURNED) TOTAL_REFUND_LAST_' + CAST(@DURATION_VALUE AS NVARCHAR (100)) + '_' + UPPER (@DURATION_INDICATOR) + '
			FROM DBO.fact_order
			WHERE QUANTITY_RETURNED > 0
			AND ORDER_DATE_TIME > DATEADD(' + UPPER (@DURATION_INDICATOR) + ',-' + CAST(@DURATION_VALUE AS NVARCHAR (100)) + ',GETDATE())
			GROUP BY ACCOUNT_ID
		';
	END
	ELSE IF UPPER (@FACT_TYPE) = 'QUANTITY RETURNED'
	BEGIN

		SET @QUERY = '
			SELECT 
				ACCOUNT_ID,
				SUM(QUANTITY_RETURNED) TTL_QUANTITY_RETURNED_LAST_' + CAST(@DURATION_VALUE AS NVARCHAR (100)) + '_' + UPPER (@DURATION_INDICATOR) + '
			FROM DBO.fact_order
			WHERE QUANTITY_RETURNED > 0
			AND ORDER_DATE_TIME > DATEADD(' + UPPER (@DURATION_INDICATOR) + ',-' + CAST(@DURATION_VALUE AS NVARCHAR (100)) + ',GETDATE())
			GROUP BY ACCOUNT_ID
		';
	END;
	
	EXEC SP_EXECUTESQL @QUERY

END; 


--*************************  EXECUTION GUIDE: *******************************

/********************************** TOTAL SALES ********************************************/
-- Total Sales 14 days
EXEC DBO.ORDER_LTV 'SALES' , 'DAY', 14
-- Total Sales 30 days
EXEC DBO.ORDER_LTV 'SALES' , 'DAY', 30
-- Total Sales 3 months
EXEC DBO.ORDER_LTV 'SALES' , 'MONTH', 3
-- Total Sales 6 months
EXEC DBO.ORDER_LTV 'SALES' , 'MONTH', 6
-- Total Sales 1 year
EXEC DBO.ORDER_LTV 'SALES' , 'YEAR', 1

/**********************************  TOTAL QUANTITY ORDERED **********************************/
-- Total Quantity Ordered 14 days
EXEC DBO.ORDER_LTV 'QUANTITY ORDERED' , 'DAY', 14
-- Total Quantity Ordered 30 days
EXEC DBO.ORDER_LTV 'QUANTITY ORDERED' , 'DAY', 30
-- Total Quantity Ordered 3 months
EXEC DBO.ORDER_LTV 'QUANTITY ORDERED' , 'MONTH', 3
-- Total Quantity Ordered 6 months
EXEC DBO.ORDER_LTV 'QUANTITY ORDERED' , 'MONTH', 6
-- Total Quantity Ordered 1 year
EXEC DBO.ORDER_LTV 'QUANTITY ORDERED' , 'YEAR', 1

/**********************************  TOTAL REFUND **********************************/
-- Total Refund 14 days
EXEC DBO.ORDER_LTV 'REFUND' , 'DAY', 14
-- Total Refund 30 days
EXEC DBO.ORDER_LTV 'REFUND' , 'DAY', 30
-- Total Refund 3 months
EXEC DBO.ORDER_LTV 'REFUND' , 'MONTH', 3
-- Total Refund 6 months
EXEC DBO.ORDER_LTV 'REFUND' , 'MONTH', 6
-- Total Refund 1 year
EXEC DBO.ORDER_LTV 'REFUND' , 'YEAR', 1


/**********************************  TOTAL QUANTITY RETURNED **********************************/
-- Total Quantity Returned 14 days
EXEC DBO.ORDER_LTV 'QUANTITY RETURNED' , 'DAY', 14
-- Total Quantity Returned 30 days
EXEC DBO.ORDER_LTV 'QUANTITY RETURNED' , 'DAY', 30
-- Total Quantity Returned 3 months
EXEC DBO.ORDER_LTV 'QUANTITY RETURNED' , 'MONTH', 3
-- Total Quantity Returned 6 months
EXEC DBO.ORDER_LTV 'QUANTITY RETURNED' , 'MONTH', 6
-- Total Quantity Returned 1 year
EXEC DBO.ORDER_LTV 'QUANTITY RETURNED' , 'YEAR', 1


